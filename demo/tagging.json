{
  "name" : "Tagging with crfs",
  "cells" : [ {
    "id" : 0,
    "compiler" : "scala",
    "input" : {
      "sessionId" : null,
      "code" : "val doc = TokenSplitter(SentenceSplitter(\n\"John Denver is a Songwriter. Denver has produced many records\"))\nval words = doc.tokens.map(_.word).distinct\nval tags = Seq(\"O\", \"B-LOC\", \"I-LOC\", \"B-PER\", \"I-PER\")\nBratRenderer.bratIE(doc)",
      "extraFields" : {
        "aggregatedCells" : "[]"
      },
      "outputFormat" : "<div class=\"string-result\"><div id=\"brat887260853\" class=\"hasSVG\" style=\"display: block; height: 36px;\"><svg version=\"1.1\" viewBox=\"0 0 641 36\" class=\"bratsvg\" style=\"width: 641px; height: 36px;\"><!-- document: undefined/undefined --><defs><filter id=\"Gaussian_Blur\"><fegaussianblur in=\"SourceGraphic\" stddeviation=\"2\"></fegaussianblur></filter><marker id=\"drag_arrow\" refX=\"5\" refY=\"2.5\" markerWidth=\"5\" markerHeight=\"5\" orient=\"auto\" markerUnits=\"strokeWidth\" class=\"drag_fill\"><polyline points=\"0,0 5,2.5 0,5 0.2,2.5\"></polyline></marker></defs><g class=\"background\"><rect x=\"0\" y=\"4\" width=\"641\" height=\"17\" class=\"background0\"></rect><rect x=\"0\" y=\"21\" width=\"641\" height=\"17\" class=\"background1\"></rect></g><g class=\"glow\"></g><g class=\"highlight\"></g><g class=\"text\"><text x=\"0\" y=\"0\"><tspan x=\"24\" y=\"15\" data-chunk-id=\"0\" class=\"brat-text\">John </tspan><tspan x=\"54.021484375\" y=\"15\" data-chunk-id=\"1\" class=\"brat-text\">Denver </tspan><tspan x=\"96.705078125\" y=\"15\" data-chunk-id=\"2\" class=\"brat-text\">is </tspan><tspan x=\"109.37109375\" y=\"15\" data-chunk-id=\"3\" class=\"brat-text\">a </tspan><tspan x=\"120.044921875\" y=\"15\" data-chunk-id=\"4\" class=\"brat-text\">Songwriter</tspan><tspan x=\"177.40234375\" y=\"15\" data-chunk-id=\"5\" class=\"brat-text\">. </tspan></text><text x=\"0\" y=\"0\"><tspan x=\"24\" y=\"32\" data-chunk-id=\"6\" class=\"brat-text\">Denver </tspan><tspan x=\"66.68359375\" y=\"32\" data-chunk-id=\"7\" class=\"brat-text\">has </tspan><tspan x=\"90.03125\" y=\"32\" data-chunk-id=\"8\" class=\"brat-text\">produced </tspan><tspan x=\"144.0703125\" y=\"32\" data-chunk-id=\"9\" class=\"brat-text\">many </tspan><tspan x=\"177.4140625\" y=\"32\" data-chunk-id=\"10\" class=\"brat-text\">records</tspan></text></g><g transform=\"translate(0, 15)\"><g></g><g transform=\"translate(24, 0)\"><g></g></g><g transform=\"translate(54.021484375, 0)\"><g></g></g><g transform=\"translate(96.705078125, 0)\"><g></g></g><g transform=\"translate(109.37109375, 0)\"><g></g></g><g transform=\"translate(120.044921875, 0)\"><g></g></g><g transform=\"translate(177.40234375, 0)\"><g></g></g><g class=\"arcs\"></g></g><g transform=\"translate(0, 32)\"><g></g><g transform=\"translate(24, 0)\"><g></g></g><g transform=\"translate(66.68359375, 0)\"><g></g></g><g transform=\"translate(90.03125, 0)\"><g></g></g><g transform=\"translate(144.0703125, 0)\"><g></g></g><g transform=\"translate(177.4140625, 0)\"><g></g></g><g class=\"arcs\"></g></g><g class=\"sentnum\"><a xmlns:xlink=\"http://www.w3.org/1999/xlink\" xlink:href=\"#undefined?focus=sent~1\"><text x=\"18\" y=\"15\" data-sent=\"1\">1</text></a><a xmlns:xlink=\"http://www.w3.org/1999/xlink\" xlink:href=\"#undefined?focus=sent~2\"><text x=\"18\" y=\"32\" data-sent=\"2\">2</text></a><path d=\"M20,0L20,36\"></path></g></svg></div>\n\n <link rel=\"stylesheet\" type=\"text/css\" href=\"/assets/javascripts/brat/style-vis.css\">\n <link rel=\"stylesheet\" type=\"text/css\" href=\"/assets/stylesheets/wolfe-brat.css\">\n\n\n<script type=\"text/javascript\">\n        var bratLocation;\n\n             console.log(\"embedBrat\");\n             if (typeof bratLocation === 'undefined') {\n                bratLocation = \"/assets/javascripts/brat\";\n                head.js(\n                    // External libraries\n                    bratLocation + '/client/lib/jquery.min.js',\n                    bratLocation + '/client/lib/jquery.svg.min.js',\n                    bratLocation + '/client/lib/jquery.svgdom.min.js',\n\n                    // brat helper modules\n                    bratLocation + '/client/src/configuration.js',\n                    bratLocation + '/client/src/util.js',\n                    bratLocation + '/client/src/annotation_log.js',\n                    bratLocation + '/client/lib/webfont.js',\n\n                    // brat modules\n                    bratLocation + '/client/src/dispatcher.js',\n                    bratLocation + '/client/src/url_monitor.js',\n                    bratLocation + '/client/src/visualizer.js'\n                 );\n                 console.log(\"head.js called\");\n             }\n\n             head.ready(function() {\n                console.log(\"Head is ready\");\n\n                var collData =\n{\n    entity_types: [  ]\n}\n      ;\n\n                var docData =\n{\n    // Our text of choice\n    text     : \"John Denver is a Songwriter. Denver has produced many records\",\n    // The entities entry holds all entity annotations\n    entities : [\n        /* Format: [{ID}, {TYPE}, [[{START}, {END}]]]\n            note that range of the offsets are [{START},{END}) */\n\n    ],\n    sentence_offsets: [[0,28],[29,61]],\n    token_offsets: [[0,4],[5,11],[12,14],[15,16],[17,27],[27,28],[29,35],[36,39],[40,48],[49,53],[54,61]]\n}\n      ;\n\n                Util.embed(\n                    // id of the div element where brat should embed the visualisations\n                    'brat887260853',\n                    // object containing collection data\n                    collData,\n                    // object containing document data\n                    docData,\n                    // Array containing locations of the visualisation fonts\n\n[\n    '/assets/javascripts/brat' + '/static/fonts/PT_Sans-Caption-Web-Regular.ttf',\n    '/assets/javascripts/brat' + '/static/fonts/Liberation_Sans-Regular.ttf'\n]\n\n                    );\n            });\n\n\n\n    </script></div>"
    }
  }, {
    "id" : 1,
    "compiler" : "scala",
    "input" : {
      "sessionId" : null,
      "code" : "val maxLength = 15\nimplicit val Words = words.toDom withOOV \"[OOV]\"\nimplicit val Tags = tags.toDom\nimplicit val Y = Seqs(Tags, 0, maxLength)\nimplicit val Weights = Vectors(dim = 1000)",
      "extraFields" : {
        "aggregatedCells" : "[\"val doc = TokenSplitter(SentenceSplitter(\\n\\\"John Denver is a Songwriter. Denver has produced many records\\\"))\\nval words = doc.tokens.map(_.word).distinct\\nval tags = Seq(\\\"O\\\", \\\"B-LOC\\\", \\\"I-LOC\\\", \\\"B-PER\\\", \\\"I-PER\\\")\\nBratRenderer.bratIE(doc)\"]"
      },
      "outputFormat" : "<div class=\"string-result\"><span class=\"asString String\">ml.wolfe.term.VectorDom@20ba2b3d</span></div>"
    }
  }, {
    "id" : 2,
    "compiler" : "scala",
    "input" : {
      "sessionId" : null,
      "code" : "\nimplicit val index = new SimpleIndex()\nimplicit val maxProductParams = MaxProductParameters(iterations = 1)\n\nval firstName = Set(\"John\", \"Jack\")\nval lastName = Set(\"Denver\")\nval location = Set(\"Denver\", \"Dallas\")\nval punct     = Set(\",\", \".\", \"?\", \";\")\ndef lowercase(w: Words.Value) = w.head.isLower\n\ndef model(w: Weights.Term)(x: Seq[Words.Value])(y: Y.Term) = {\n    sum(0 until x.length) { i => \n        (w dot feature('bias, y(i))) +\n        (w dot feature('word, y(i) -> Words.Const(x(i)))) +\n        (w dot feature('firstName, I(Bools.Const(firstName(x(i)))), y(i))) +\n        (w dot feature('lastName, I(Bools.Const(lastName(x(i)))), y(i))) +\n        (w dot feature('location, I(Bools.Const(location(x(i)))), y(i))) +\n        (w dot feature('lowercase, I(Bools.Const(lowercase(x(i)))), y(i))) +\n        (w dot feature('punct, I(Bools.Const(punct(x(i)))), y(i)))\n    } + sum(0 until x.length - 1) { i => \n        w dot feature('pair, y(i) -> y(i + 1))\n    }\n} subjectTo (y.length === x.length)",
      "extraFields" : {
        "aggregatedCells" : "[\"val doc = TokenSplitter(SentenceSplitter(\\n\\\"John Denver is a Songwriter. Denver has produced many records\\\"))\\nval words = doc.tokens.map(_.word).distinct\\nval tags = Seq(\\\"O\\\", \\\"B-LOC\\\", \\\"I-LOC\\\", \\\"B-PER\\\", \\\"I-PER\\\")\\nBratRenderer.bratIE(doc)\",\"val maxLength = 15\\nimplicit val Words = words.toDom withOOV \\\"[OOV]\\\"\\nimplicit val Tags = tags.toDom\\nimplicit val Y = Seqs(Tags, 0, maxLength)\\nimplicit val Weights = Vectors(dim = 1000)\"]"
      },
      "outputFormat" : "<div class=\"string-result\"><div class=\"asIterable Set\"><span class=\"typeName\">Set</span>\n<ul start=\"0\" class=\"fields\">\n  <li class=\"fieldValue\"><span class=\"asString String\">,</span></li>\n  <li class=\"fieldValue\"><span class=\"asString String\">.</span></li>\n  <li class=\"fieldValue\"><span class=\"asString String\">?</span></li>\n  <li class=\"fieldValue\"><span class=\"asString String\">;</span></li>\n</ul>\n</div></div>"
    }
  }, {
    "id" : 4,
    "compiler" : "scala",
    "input" : {
      "sessionId" : null,
      "code" : "import cc.factorie.la.DenseTensor1\nval wStar = new DenseTensor1(Seq(\n    feature('location,  1.1, Tags.Const(\"B-LOC\")),\n    feature('lastName,  1.0, Tags.Const(\"B-PER\")),\n    feature('firstName, 3.0, Tags.Const(\"B-PER\")),\n    feature('lowercase, 1.0, Tags.Const(\"O\")),\n    feature('punct, 1.0, Tags.Const(\"O\")),\n    feature('pair, 2.0, Tags.Const(\"B-PER\") -> Tags.Const(\"I-PER\")),\n    feature('bias, 1.0, Tags.Const(\"O\")),\n    feature('match, 2.0, Tags.Const(\"B-PER\") -> Tags.Const(\"B-PER\")),\n    feature('match, 2.0, Tags.Const(\"B-PER\") -> Tags.Const(\"I-PER\")),\n    feature('match, 2.0, Tags.Const(\"I-PER\") -> Tags.Const(\"I-PER\")),\n    feature('match, 2.0, Tags.Const(\"I-PER\") -> Tags.Const(\"B-PER\"))\n  ).map(_.eval()).reduce(_+_))",
      "extraFields" : {
        "aggregatedCells" : "[\"val doc = TokenSplitter(SentenceSplitter(\\n\\\"John Denver is a Songwriter. Denver has produced many records\\\"))\\nval words = doc.tokens.map(_.word).distinct\\nval tags = Seq(\\\"O\\\", \\\"B-LOC\\\", \\\"I-LOC\\\", \\\"B-PER\\\", \\\"I-PER\\\")\\nBratRenderer.bratIE(doc)\",\"val maxLength = 15\\nimplicit val Words = words.toDom withOOV \\\"[OOV]\\\"\\nimplicit val Tags = tags.toDom\\nimplicit val Y = Seqs(Tags, 0, maxLength)\\nimplicit val Weights = Vectors(dim = 1000)\",\"\\nimplicit val index = new SimpleIndex()\\nimplicit val maxProductParams = MaxProductParameters(iterations = 2)\\n\\nval firstName = Set(\\\"John\\\", \\\"Jack\\\")\\nval lastName = Set(\\\"Denver\\\")\\nval location = Set(\\\"Denver\\\", \\\"Dallas\\\")\\nval punct     = Set(\\\",\\\", \\\".\\\", \\\"?\\\", \\\";\\\")\\ndef lowercase(w: Words.Value) = w.head.isLower\\n\\ndef model(w: Weights.Term)(x: Seq[Words.Value])(y: Y.Term) = {\\ndef matches = matchingPairs(x)\\n    sum(0 until x.length) { i => \\n        w dot feature('bias, y(i)) +\\n        w dot feature('word, y(i) -> Words.Const(x(i))) +\\n        w dot feature('firstName, I(Bools.Const(firstName(x(i)))), y(i)) +\\n        w dot feature('lastName, I(Bools.Const(lastName(x(i)))), y(i)) +\\n        w dot feature('location, I(Bools.Const(location(x(i)))), y(i)) +\\n        w dot feature('lowercase, I(Bools.Const(lowercase(x(i)))), y(i)) +\\n        w dot feature('punct, I(Bools.Const(punct(x(i)))), y(i)) +\\n    } + sum(0 until x.length - 1) { i => \\n        w dot feature('pair, y(i) -> y(i + 1))\\n    }\\n} subjectTo (y.length === x.length)\",\"\"]"
      },
      "outputFormat" : "<div class=\"text-center\"><i class=\"fa fa-refresh fa-spin fa-lg\"></i></div>"
    }
  }, {
    "id" : 5,
    "compiler" : "scala",
    "input" : {
      "sessionId" : null,
      "code" : "val xTest = doc.tokens.map(_.word)\n\ndef predict(x:X.Value) = argmax(Y) {\n    model(Weights.Const(wStar))(X.Const(x))\n} by maxProduct\nval result = predict(xTest).evalResult()",
      "extraFields" : {
        "aggregatedCells" : "[\"val doc = TokenSplitter(SentenceSplitter(\\n\\\"John Denver is a Songwriter. Denver has produced many records\\\"))\\nval words = doc.tokens.map(_.word).distinct\\nval tags = Seq(\\\"O\\\", \\\"B-LOC\\\", \\\"I-LOC\\\", \\\"B-PER\\\", \\\"I-PER\\\")\\nBratRenderer.bratIE(doc)\",\"val maxLength = 15\\nimplicit val Words = words.toDom withOOV \\\"[OOV]\\\"\\nimplicit val Tags = tags.toDom\\nimplicit val Y = Seqs(Tags, 0, maxLength)\\nimplicit val Weights = Vectors(dim = 1000)\",\"\\nimplicit val index = new SimpleIndex()\\nimplicit val maxProductParams = MaxProductParameters(iterations = 2)\\n\\nval firstName = Set(\\\"John\\\", \\\"Jack\\\")\\nval lastName = Set(\\\"Denver\\\")\\nval location = Set(\\\"Denver\\\", \\\"Dallas\\\")\\nval punct     = Set(\\\",\\\", \\\".\\\", \\\"?\\\", \\\";\\\")\\ndef lowercase(w: Words.Value) = w.head.isLower\\n\\ndef model(w: Weights.Term)(x: Seq[Words.Value])(y: Y.Term) = {\\ndef matches = matchingPairs(x)\\n    sum(0 until x.length) { i => \\n        w dot feature('bias, y(i)) +\\n        w dot feature('word, y(i) -> Words.Const(x(i))) +\\n        w dot feature('firstName, I(Bools.Const(firstName(x(i)))), y(i)) +\\n        w dot feature('lastName, I(Bools.Const(lastName(x(i)))), y(i)) +\\n        w dot feature('location, I(Bools.Const(location(x(i)))), y(i)) +\\n        w dot feature('lowercase, I(Bools.Const(lowercase(x(i)))), y(i)) +\\n        w dot feature('punct, I(Bools.Const(punct(x(i)))), y(i)) +\\n    } + sum(0 until x.length - 1) { i => \\n        w dot feature('pair, y(i) -> y(i + 1))\\n    }\\n} subjectTo (y.length === x.length)\",\"\",\"\"]"
      },
      "outputFormat" : "<div class=\"text-center\"><i class=\"fa fa-refresh fa-spin fa-lg\"></i></div>"
    }
  }, {
    "id" : 6,
    "compiler" : "scala",
    "input" : {
      "sessionId" : null,
      "code" : "result.factorGraphs.head",
      "extraFields" : {
        "aggregatedCells" : "[\"val doc = TokenSplitter(SentenceSplitter(\\n\\\"John Denver is a Songwriter. Denver has produced many records\\\"))\\nval words = doc.tokens.map(_.word).distinct\\nval tags = Seq(\\\"O\\\", \\\"B-LOC\\\", \\\"I-LOC\\\", \\\"B-PER\\\", \\\"I-PER\\\")\\nBratRenderer.bratIE(doc)\",\"val maxLength = 15\\nimplicit val Words = words.toDom withOOV \\\"[OOV]\\\"\\nimplicit val Tags = tags.toDom\\nimplicit val Y = Seqs(Tags, 0, maxLength)\\nimplicit val Weights = Vectors(dim = 1000)\",\"\\nimplicit val index = new SimpleIndex()\\nimplicit val maxProductParams = MaxProductParameters(iterations = 2)\\n\\nval firstName = Set(\\\"John\\\", \\\"Jack\\\")\\nval lastName = Set(\\\"Denver\\\")\\nval location = Set(\\\"Denver\\\", \\\"Dallas\\\")\\nval punct     = Set(\\\",\\\", \\\".\\\", \\\"?\\\", \\\";\\\")\\ndef lowercase(w: Words.Value) = w.head.isLower\\n\\ndef model(w: Weights.Term)(x: Seq[Words.Value])(y: Y.Term) = {\\ndef matches = matchingPairs(x)\\n    sum(0 until x.length) { i => \\n        w dot feature('bias, y(i)) +\\n        w dot feature('word, y(i) -> Words.Const(x(i))) +\\n        w dot feature('firstName, I(Bools.Const(firstName(x(i)))), y(i)) +\\n        w dot feature('lastName, I(Bools.Const(lastName(x(i)))), y(i)) +\\n        w dot feature('location, I(Bools.Const(location(x(i)))), y(i)) +\\n        w dot feature('lowercase, I(Bools.Const(lowercase(x(i)))), y(i)) +\\n        w dot feature('punct, I(Bools.Const(punct(x(i)))), y(i)) +\\n    } + sum(0 until x.length - 1) { i => \\n        w dot feature('pair, y(i) -> y(i + 1))\\n    }\\n} subjectTo (y.length === x.length)\",\"\",\"\",\"def predict(x:X.Value) = argmax(Y) {\\n    model(Weights.Const(wStar))(X.Const(x))\\n} by maxProduct\\nval xTest = doc.tokens.take(3).map(_.word)\\nval result = predict(xTest).evalResult()\\nval yStar = result.value\"]"
      },
      "outputFormat" : "<div class=\"text-center\"><i class=\"fa fa-refresh fa-spin fa-lg\"></i></div>"
    }
  }, {
    "id" : 10,
    "compiler" : "scala",
    "input" : {
      "sessionId" : null,
      "code" : "def matchingPairs(x: Seq[Words.Value]) =\n    for (j <- 0 until x.length; i <- 0 until j; if x(i) != \".\" && x(i) == x(j)) yield (i, j)\n    \ndef skipModel(w: Weights.Term)(x: Seq[Words.Value])(y: Y.Term) = {\n    def matches = matchingPairs(x)\n    model(w)(x)(y) + \n    sum(0 until matches.length) { i => \n        w dot feature('match, y(matches(i)._1) -> y(matches(i)._2))\n    }\n}\n\ndef predict2(x:X.Value) = argmax(Y) {\n    skipModel(Weights.Const(wStar))(X.Const(x))\n} by maxProduct\n\nval result2 = predict(xTest).evalResult()",
      "extraFields" : {
        "aggregatedCells" : "[\"val doc = TokenSplitter(SentenceSplitter(\\n\\\"John Denver is a Songwriter. Denver has produced many records\\\"))\\nval words = doc.tokens.map(_.word).distinct\\nval tags = Seq(\\\"O\\\", \\\"B-LOC\\\", \\\"I-LOC\\\", \\\"B-PER\\\", \\\"I-PER\\\")\\nBratRenderer.bratIE(doc)\",\"val maxLength = 15\\nimplicit val Words = words.toDom withOOV \\\"[OOV]\\\"\\nimplicit val Tags = tags.toDom\\nimplicit val Y = Seqs(Tags, 0, maxLength)\\nimplicit val Weights = Vectors(dim = 1000)\",\"\\nimplicit val index = new SimpleIndex()\\nimplicit val maxProductParams = MaxProductParameters(iterations = 2)\\n\\nval firstName = Set(\\\"John\\\", \\\"Jack\\\")\\nval lastName = Set(\\\"Denver\\\")\\nval location = Set(\\\"Denver\\\", \\\"Dallas\\\")\\nval punct     = Set(\\\",\\\", \\\".\\\", \\\"?\\\", \\\";\\\")\\ndef lowercase(w: Words.Value) = w.head.isLower\\n\\ndef model(w: Weights.Term)(x: Seq[Words.Value])(y: Y.Term) = {\\ndef matches = matchingPairs(x)\\n    sum(0 until x.length) { i => \\n        w dot feature('bias, y(i)) +\\n        w dot feature('word, y(i) -> Words.Const(x(i))) +\\n        w dot feature('firstName, I(Bools.Const(firstName(x(i)))), y(i)) +\\n        w dot feature('lastName, I(Bools.Const(lastName(x(i)))), y(i)) +\\n        w dot feature('location, I(Bools.Const(location(x(i)))), y(i)) +\\n        w dot feature('lowercase, I(Bools.Const(lowercase(x(i)))), y(i)) +\\n        w dot feature('punct, I(Bools.Const(punct(x(i)))), y(i)) +\\n    } + sum(0 until x.length - 1) { i => \\n        w dot feature('pair, y(i) -> y(i + 1))\\n    }\\n} subjectTo (y.length === x.length)\",\"\",\"\",\"def predict(x:X.Value) = argmax(Y) {\\n    model(Weights.Const(wStar))(X.Const(x))\\n} by maxProduct\\nval xTest = doc.tokens.take(3).map(_.word)\\nval result = predict(xTest).evalResult()\\nval yStar = result.value\",\"result.factorGraphs.head\",\"\",\"\",\"\"]"
      },
      "outputFormat" : ""
    }
  }, {
    "id" : 11,
    "compiler" : "scala",
    "input" : {
      "sessionId" : null,
      "code" : "result2.factorGraphs.head",
      "extraFields" : { },
      "outputFormat" : ""
    }
  } ],
  "config" : { }
}
